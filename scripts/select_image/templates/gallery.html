
<!DOCTYPE html>
    <html lang="en">
        
        <head>
        
        <meta charset="utf-8" />

        <title>Image Selector</title>

        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
            .container { display: flex; height: 100vh; }
            #rightPane { flex: 1; display: flex; flex-direction: column; }
            #navBtns { padding:4px; border-top:1px solid #ccc; display:flex; gap:8px; justify-content:center; }
            #navBtns button { padding:4px 8px; cursor:pointer; }
            #infoPane { padding: 0.5rem; border-bottom: 1px solid #ccc; flex: 0 0 30%; max-height: 30%; overflow-y: auto; }
            #fileList { width: 320px; border-right: 1px solid #ccc; overflow-y: auto; padding: 1rem; }
            #fileList ul { list-style: none; margin: 0; padding: 0; }
            #fileList li { cursor: pointer; padding: 4px 2px; user-select: none; }
            #fileList li:hover { background-color: #f0f0f0; }
            .segment-group { margin-bottom: 1rem; }
            .segment-header { 
                font-weight: bold; 
                color: #333; 
                background-color: #f5f5f5; 
                padding: 6px 8px; 
                margin: 4px 0; 
                border-left: 3px solid #007acc;
                font-size: 0.9em;
            }
            .segment-header.active { background-color: #e6f3ff; border-left-color: #0056b3; }
            .segment-images { margin-left: 8px; }
            .segment-images li { padding-left: 8px; border-left: 1px solid #e0e0e0; }
            .selected { background-color: #d0e0ff; }
            .confirmed { background-color: #cccccc; }
            #toast { position: fixed; right: 1rem; bottom: 1rem; background: rgba(0,0,0,0.8); color:#fff; padding:8px 12px; border-radius:4px; opacity:0; transition: opacity .3s; pointer-events:none; }
            #toast.show { opacity:1; }
            #preview { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 1rem; }
            #preview img { height: auto; width: auto; max-width: 100%; max-height: 100%; }
            .segment { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e0e0e0; }
            .seg-title { font-weight: bold; color: #333; margin-bottom: 0.25rem; }
            .seg-images { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
            .seg-images img { max-width:100px; height:auto; border:1px solid #ccc; }
            .current-seg { background-color:#fffbe6; }
        </style>
        </head>

        <body>
            <h2 style="margin:0; padding:1rem;">Select an image</h2>
            <div class="container">
            <div id="fileList">
                {% if grouped_images and segments %}
                    <!-- Grouped by segments -->
                    {% for i in range(segments|length) %}
                        {% set segment = segments[i] %}
                        {% set segment_images = grouped_images.get('segment_' + i|string, []) %}
                        {% if segment_images %}
                        <div class="segment-group">
                            <div class="segment-header" data-segment="{{ i }}">
                                {{ segment.start }} ~ {{ segment.end }}
                                <br><span style="font-weight: normal; font-size: 0.85em; color: #666;">
                                {{ segment.text[:50] }}{% if segment.text|length > 50 %}...{% endif %}
                                </span>
                            </div>
                            <ul class="segment-images">
                                {% for img in segment_images %}
                                <li data-file="{{ img }}" data-segment="{{ i }}">{{ img }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Ungrouped images -->
                    {% if grouped_images.get('ungrouped', []) %}
                    <div class="segment-group">
                        <div class="segment-header">其他圖片</div>
                        <ul class="segment-images">
                            {% for img in grouped_images.ungrouped %}
                            <li data-file="{{ img }}" data-segment="-1">{{ img }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- Fallback: show all images without grouping -->
                    <ul>
                    {% for img in images %}
                    <li data-file="{{ img }}" data-segment="-1">{{ img }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}
            </div>
                <div id="rightPane">
                    <div id="infoPane"></div>
                    <div id="preview" style="flex:1; display:flex; justify-content:center; align-items:flex-start; padding:1rem;">
                        <img id="previewImg" src="" alt="preview" />
                    </div>
                </div>
            </div>
            <div id="toast" ></div>

            <script>
            async function postSelection(file) {
            const res = await fetch('/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file })
            });
            if (!res.ok) {
                alert('Error: ' + (await res.text()));
            }
            }

            function showPreview(file) {
            const img = document.getElementById('previewImg');
            img.src = '/static/' + file;
            }

            
            </script>
            
            <script>
            // --- enhanced navigation and selection ---
            const listItems = Array.from(document.querySelectorAll('#fileList li[data-file]'));
            const segmentHeaders = Array.from(document.querySelectorAll('.segment-header[data-segment]'));

            // toast helper
            function showToast(msg){
            const toast=document.getElementById('toast');
            toast.textContent=msg;
            toast.classList.add('show');
            setTimeout(()=>toast.classList.remove('show'),2000);
            }

            function confirmFile(file, li){
            const segmentIdx = li ? parseInt(li.dataset.segment) : segIdx;
            const actualSegIdx = segmentIdx >= 0 ? segmentIdx : segIdx;
            const selArr = (selections[actualSegIdx] ??= []);
            const wrap = segDivs[actualSegIdx]?.querySelector('.seg-images');
            const idx = selArr.indexOf(file);
            if(idx === -1){
                // add
                postSelection(file);
                selArr.push(file);
                if(li) li.classList.add('confirmed');
                showToast('已添加內容');
                if(wrap){
                    const thumb = document.createElement('img');
                    thumb.src = '/static/' + file;
                    thumb.dataset.file = file;
                    wrap.appendChild(thumb);
                }
            }else{
                // remove
                selArr.splice(idx,1);
                if(li) li.classList.remove('confirmed');
                showToast('已移除');
                if(wrap){
                    const img = wrap.querySelector(`img[data-file="${file}"]`);
                    if(img) img.remove();
                }
            }
            }

            let currentIndex = 0;
            function highlight(idx) {
            if (listItems.length === 0) return;
            listItems.forEach(li => li.classList.remove('selected'));
            segmentHeaders.forEach(h => h.classList.remove('active'));
            currentIndex = (idx + listItems.length) % listItems.length;
            const li = listItems[currentIndex];
            li.classList.add('selected');
            li.scrollIntoView({behavior:'auto',block:'nearest'});
            showPreview(li.dataset.file);
            
            // Highlight corresponding segment header
            const segmentIdx = parseInt(li.dataset.segment);
            if (segmentIdx >= 0) {
                const header = segmentHeaders.find(h => parseInt(h.dataset.segment) === segmentIdx);
                if (header) header.classList.add('active');
            }
            }

            // initial highlight first item
            if (listItems.length) {
            highlight(0);
            }

            // click handler override to use highlight and confirm
            listItems.forEach((li, idx) => {
            li.addEventListener('click', () => {
                highlight(idx);
                confirmFile(li.dataset.file, li);
            });
            });

            // keyboard navigation
            const nextBtnEl = document.getElementById('nextBtn');
            if(nextBtnEl) nextBtnEl.addEventListener('click', advanceSegment);
            const prevBtnEl = document.getElementById('prevBtn');
            if(prevBtnEl) prevBtnEl.addEventListener('click', prevSegment);

            window.addEventListener('keydown', (ev) => {
            if (ev.key === 'ArrowDown') {
                ev.preventDefault();
                highlight(currentIndex + 1);
            } else if (ev.key === 'ArrowUp') {
                ev.preventDefault();
                highlight(currentIndex - 1);
            } else if (ev.key === 'ArrowRight') {
                ev.preventDefault();
                advanceSegment();
            } else if (ev.key === 'ArrowLeft') {
                ev.preventDefault();
                prevSegment();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                if (listItems.length) {
                confirmFile(listItems[currentIndex].dataset.file, listItems[currentIndex]);
                }
            }
            });
            // --- end navigation ---

            // ------- load transcript segments incrementally -------
            let segments = [];
            let segIdx = 0;
            let segDivs = [];
            const selections = {}; // segIdx -> array of filenames
            async function loadSegments() {
                const res = await fetch('/segments');
                if (!res.ok) return;
                segments = await res.json();
                renderNextSegment();
            }
            function setCurrentSegment(idx){
                // update segment highlight
                segDivs.forEach(d=>d.classList.remove('current-seg'));
                if(idx>=0 && idx<segDivs.length){
                    segDivs[idx].classList.add('current-seg');
                    segDivs[idx].scrollIntoView({behavior:'smooth',block:'nearest'});
                }
                // refresh confirmed state on file list
                listItems.forEach(li=>li.classList.remove('confirmed'));
                const selectedFiles = selections[idx] ?? [];
                listItems.forEach(li=>{
                    if(selectedFiles.includes(li.dataset.file)){
                        li.classList.add('confirmed');
                    }
                });
            }
            function renderNextSegment() {
                if (segIdx >= segments.length) return;
                const pane = document.getElementById('infoPane');
                const seg = segments[segIdx];
                const div = document.createElement('div');
                div.className = 'segment';
                const title = document.createElement('div');
                title.className = 'seg-title';
                title.textContent = `${seg.start} ~ ${seg.end}`;
                const p = document.createElement('p');
                p.textContent = seg.text;
                const imgWrap = document.createElement('div');
                imgWrap.className = 'seg-images';
                div.appendChild(title);
                div.appendChild(p);
                div.appendChild(imgWrap);
                pane.appendChild(div);
                segDivs.push(div);
                pane.scrollTop = pane.scrollHeight;
                setCurrentSegment(segIdx);
            }
            // Advance after confirming image for current segment
            function advanceSegment() {
                if(segIdx < segments.length-1){
                    segIdx += 1;
                    if(segDivs.length>segIdx){
                        setCurrentSegment(segIdx);
                    }else{
                        renderNextSegment();
                    }
                }
            }
            function prevSegment(){
                if(segIdx>0){
                    segIdx -=1;
                    setCurrentSegment(segIdx);
                }
            }
            loadSegments();
            // ------- end segments -------
            </script>

        </body> 
    </html>
