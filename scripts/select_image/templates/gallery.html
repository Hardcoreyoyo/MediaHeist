
<!DOCTYPE html>
    <html lang="en">
        
        <head>
        
        <meta charset="utf-8" />

        <title>Image Selector</title>

        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
            .container { display: flex; margin-top: 72px; height: calc(100vh - 72px); }
            #rightPane { flex: 1; display: flex; flex-direction: column; }
            #navBtns { padding:4px; border-top:1px solid #ccc; display:flex; gap:8px; justify-content:center; }
            #navBtns button { padding:4px 8px; cursor:pointer; }
            #infoPane { padding: 0.5rem; border-bottom: 1px solid #ccc; flex: 0 0 30%; max-height: 30%; overflow-y: auto; background:#fff; }
            #fileList { width: 16%; border-right: 1px solid #ccc; overflow-y: auto; padding: 1rem; padding-top: 0px; box-sizing:border-box;padding-left: 24px; }
            #fileList ul { list-style: none; margin: 0; padding: 0; }
            #fileList li { cursor: pointer; padding: 4px 2px; user-select: none; }
            #fileList li:hover { background-color: #f0f0f0; }
            .segment-group { margin-bottom: 1rem; }
            .segment-header { 
                font-weight: bold; 
                color: #333; 
                background-color: #f5f5f5; 
                padding: 6px 8px; 
                margin: 4px 0; 
                border-left: 3px solid #007acc;
                font-size: 0.9em;
            }
            .segment-header.active { background-color: #e6f3ff; border-left-color: #0056b3; }
            .segment-images { margin-left: 8px; }
            .segment-images li { padding-left: 8px; border-left: 1px solid #e0e0e0; scroll-margin-top: 80px; }
            .selected {
            background-color: transparent;
            position: relative;
            font-weight: bold;
            }
            .selected::before {
                content: "\2192";
                position: absolute;
                left: -20px;
                color: #000;
                font-weight: bold;
            }
            .confirmed {
            background-color: transparent;
            position: relative;
            }
            .confirmed::after {
                content: " \2022";
                color: #000;
                margin-left: 4px;
}
            #toast { position: fixed; right: 1rem; bottom: 1rem; background: rgba(0,0,0,0.8); color:#fff; padding:8px 12px; border-radius:4px; opacity:0; transition: opacity .3s; pointer-events:none; z-index: 1000; }
            #toast.show { opacity:1; }
            #preview { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 1rem; }
            #preview img { height: auto; width: auto; max-width: 100%; max-height: 100%; }
            .segment { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e0e0e0; }
            .seg-title { font-weight: bold; color: #333; margin-bottom: 0.25rem; }
            .seg-images { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
            .seg-images img { max-width:100px; height:auto; border:1px solid #ccc; }
            .current-seg { background-color:#fffbe6; }
            
            /* Modal styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            }
            .modal-overlay.show {
                display: flex;
            }
            .modal-content {
                background: white;
                border-radius: 8px;
                padding: 2rem;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            .modal-header {
                font-size: 1.2em;
                font-weight: bold;
                margin-bottom: 1rem;
                color: #333;
            }
            .modal-body {
                margin-bottom: 1.5rem;
                line-height: 1.5;
                color: #666;
            }
            .modal-stats {
                background: #f5f5f5;
                padding: 1rem;
                border-radius: 4px;
                margin: 1rem 0;
                font-family: monospace;
                font-size: 0.9em;
            }
            .modal-buttons {
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
            }
            .modal-btn {
                padding: 0.5rem 1.5rem;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1em;
                transition: background-color 0.2s;
            }
            .modal-btn-cancel {
                background: #e0e0e0;
                color: #333;
            }
            .modal-btn-cancel:hover {
                background: #d0d0d0;
            }
            .modal-btn-confirm {
                background: #007acc;
                color: white;
            }
            .modal-btn-confirm:hover {
                background: #0056b3;
            }
            .modal-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        </style>
        </head>

        <body>
            <h2 style="position:sticky; top:0; z-index:1500; background:#fff; margin:0; padding:1rem; border-bottom:1px solid #ccc;">Select an image <span style="font-size:0.7em; color:#666;">(Cmd+Enter 匯出)</span></h2>
            <div class="container">
            <div id="fileList">
                {% if grouped_images and segments %}
                    <!-- Grouped by segments -->
                    {% for i in range(segments|length) %}
                        {% set segment = segments[i] %}
                        {% set segment_images = grouped_images.get('segment_' + i|string, []) %}
                        {% if segment_images %}
                        <div class="segment-group">
                            <div class="segment-header" data-segment="{{ i }}">
                                {{ segment.start }} ~ {{ segment.end }}
                                <br><span style="font-weight: normal; font-size: 0.85em; color: #666;">
                                {{ segment.text[:50] }}{% if segment.text|length > 50 %}...{% endif %}
                                </span>
                            </div>
                            <ul class="segment-images">
                                {% for img in segment_images %}
                                <li data-file="{{ img }}" data-segment="{{ i }}">{{ img }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Ungrouped images -->
                    {% if grouped_images.get('ungrouped', []) %}
                    <div class="segment-group">
                        <div class="segment-header">其他圖片</div>
                        <ul class="segment-images">
                            {% for img in grouped_images.ungrouped %}
                            <li data-file="{{ img }}" data-segment="ungrouped">{{ img }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- Fallback: show all images without grouping -->
                    <ul>
                    {% for img in images %}
                    <li data-file="{{ img }}" data-segment="ungrouped">{{ img }}</li>
                    {% endfor %}
                    </ul>
                {% endif %}
            </div>
                <div id="rightPane">
                    <div id="infoPane"></div>
                    <div id="preview" style="flex:1; display:flex; justify-content:center; align-items:flex-start; padding:1rem;">
                        <img id="previewImg" src="" alt="preview" />
                    </div>
                </div>
            </div>
            <div id="toast" ></div>

            <!-- Export Confirmation Modal -->
            <div id="exportModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">確認匯出內容</div>
                    <div class="modal-body">
                        確定要匯出所有已選擇的圖片和文字內容嗎？
                        <div id="exportStats" class="modal-stats"></div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-cancel" onclick="hideExportModal()">取消</button>
                        <button class="modal-btn modal-btn-confirm" onclick="confirmExport()" id="confirmExportBtn">確認匯出</button>
                    </div>
                </div>
            </div>

            <script>
            async function postSelection(file) {
            const res = await fetch('/select', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: file })
            });
            if (!res.ok) {
                alert('Error: ' + (await res.text()));
            }
            }

            function showPreview(file) {
            const img = document.getElementById('previewImg');
            img.src = '/static/' + file;
            }

            
            </script>
            
            <script>
            // --- enhanced navigation and selection ---
            const listItems = Array.from(document.querySelectorAll('#fileList li[data-file]'));
            const segmentHeaders = Array.from(document.querySelectorAll('.segment-header[data-segment]'));

            // toast helper
            function showToast(msg){
            const toast=document.getElementById('toast');
            toast.textContent=msg;
            toast.classList.add('show');
            setTimeout(()=>toast.classList.remove('show'),2000);
            }

            function confirmFile(file, li){
            const segmentIdx = li ? li.dataset.segment : String(segIdx);
            const actualSegIdx = segmentIdx !== 'ungrouped' ? parseInt(segmentIdx) : segIdx;
            const selectionKey = segmentIdx === 'ungrouped' ? 'ungrouped' : String(actualSegIdx >= 0 ? actualSegIdx : segIdx);
            const selArr = (selections[selectionKey] ??= []);
            const wrap = segDivs[actualSegIdx >= 0 ? actualSegIdx : 0]?.querySelector('.seg-images');
            const idx = selArr.indexOf(file);
            if(idx === -1){
                // add
                postSelection(file);
                selArr.push(file);
                if(li) li.classList.add('confirmed');
                showToast('已添加內容');
                if(wrap && segmentIdx !== 'ungrouped'){
                    const thumb = document.createElement('img');
                    thumb.src = '/static/' + file;
                    thumb.dataset.file = file;
                    wrap.appendChild(thumb);
                    // after adding, align segment bottom to pane bottom
                    const pane = document.getElementById('infoPane');
                    const seg = segDivs[segIdx];
                    if(seg){
                        const bottom = seg.getBoundingClientRect().bottom - pane.getBoundingClientRect().top + pane.scrollTop;
                        const target = bottom - pane.clientHeight;
                        pane.scrollTo({top: target, behavior:'auto'});
                    }
                }
            }else{
                // remove
                selArr.splice(idx,1);
                if(li) li.classList.remove('confirmed');
                showToast('已移除');
                if(wrap && segmentIdx !== 'ungrouped'){
                    const img = wrap.querySelector(`img[data-file="${file}"]`);
                    if(img) img.remove();
                }

            }
            }

            let currentIndex = 0;
            function highlight(idx) {
            if (listItems.length === 0) return;
            listItems.forEach(li => li.classList.remove('selected'));
            segmentHeaders.forEach(h => h.classList.remove('active'));
            currentIndex = (idx + listItems.length) % listItems.length;
            const li = listItems[currentIndex];
            li.classList.add('selected');
            li.scrollIntoView({behavior:'auto',block:'nearest'});
            showPreview(li.dataset.file);
            
            // Highlight corresponding segment header
            const segmentIdx = li.dataset.segment;
            if (segmentIdx !== 'ungrouped' && segmentIdx !== '-1') {
                const header = segmentHeaders.find(h => h.dataset.segment === segmentIdx);
                if (header) header.classList.add('active');
            }
            }

            // Move cursor within current segment only
            function nextInSegment(delta){
                if(listItems.length===0) return;
                const currentSeg = String(segIdx);
                let idx = currentIndex;
                do{
                    idx = (idx + delta + listItems.length) % listItems.length;
                }while(listItems[idx].dataset.segment !== currentSeg && idx !== currentIndex);
                highlight(idx);
            }

            // initial highlight first item
            if (listItems.length) {
            highlight(0);
            }

            // click handler override to use highlight and confirm
            listItems.forEach((li, idx) => {
            li.addEventListener('click', () => {
                highlight(idx);
                confirmFile(li.dataset.file, li);
            });
            });

            // keyboard navigation
            const nextBtnEl = document.getElementById('nextBtn');
            if(nextBtnEl) nextBtnEl.addEventListener('click', advanceSegment);
            const prevBtnEl = document.getElementById('prevBtn');
            if(prevBtnEl) prevBtnEl.addEventListener('click', prevSegment);

            window.addEventListener('keydown', (ev) => {
            // Check for Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux)
            if ((ev.metaKey || ev.ctrlKey) && ev.key === 'Enter') {
                ev.preventDefault();
                showExportModal();
                return;
            }
            
            if (ev.key === 'ArrowDown') {
                ev.preventDefault();
                nextInSegment(1);
            } else if (ev.key === 'ArrowUp') {
                ev.preventDefault();
                nextInSegment(-1);
            } else if (ev.key === 'ArrowRight') {
                ev.preventDefault();
                advanceSegment();
            } else if (ev.key === 'ArrowLeft') {
                ev.preventDefault();
                prevSegment();
            } else if (ev.key === 'Enter') {
                ev.preventDefault();
                if (listItems.length) {
                confirmFile(listItems[currentIndex].dataset.file, listItems[currentIndex]);
                }
            }
            });
            // --- end navigation ---

            // ------- load transcript segments incrementally -------
            let segments = [];
            let segIdx = 0;
            let segDivs = [];
            const selections = {}; // segIdx -> array of filenames
            async function loadSegments() {
                const res = await fetch('/segments');
                if (!res.ok) return;
                segments = await res.json();
                renderNextSegment();
            }
            function setCurrentSegment(idx){
                // update segment highlight
                segDivs.forEach(d=>d.classList.remove('current-seg'));
                if(idx>=0 && idx<segDivs.length){
                    segDivs[idx].classList.add('current-seg');
                    const pane = document.getElementById('infoPane');
                    const target = segDivs[idx].getBoundingClientRect().top - pane.getBoundingClientRect().top + pane.scrollTop;
                    pane.scrollTo({top: target, behavior:'smooth'});
                }

                // automatically highlight the first image belonging to this segment
                const firstLi = listItems.find(li => li.dataset.segment === String(idx));
                if(firstLi){
                    highlight(listItems.indexOf(firstLi));
                    // scroll list so the first item is at top of view
                    firstLi.scrollIntoView({behavior:'smooth', block:'start'});
                }
                // refresh confirmed state on file list
                listItems.forEach(li=>li.classList.remove('confirmed'));
                const selectedFiles = selections[String(idx)] ?? [];
                const ungroupedFiles = selections['ungrouped'] ?? [];
                listItems.forEach(li=>{
                    const segmentIdx = li.dataset.segment;
                    if(segmentIdx === 'ungrouped' && ungroupedFiles.includes(li.dataset.file)){
                        li.classList.add('confirmed');
                    } else if(segmentIdx === String(idx) && selectedFiles.includes(li.dataset.file)){
                        li.classList.add('confirmed');
                    }
                });
            }
            function renderNextSegment() {
                if (segIdx >= segments.length) return;
                const pane = document.getElementById('infoPane');
                const seg = segments[segIdx];
                const div = document.createElement('div');
                div.className = 'segment';
                const title = document.createElement('div');
                title.className = 'seg-title';
                title.textContent = `${seg.start} ~ ${seg.end}`;
                const p = document.createElement('p');
                p.textContent = seg.text;
                const imgWrap = document.createElement('div');
                imgWrap.className = 'seg-images';
                div.appendChild(title);
                div.appendChild(p);
                div.appendChild(imgWrap);
                pane.appendChild(div);
                segDivs.push(div);
                pane.scrollTop = pane.scrollHeight;
                setCurrentSegment(segIdx);
            }
            // Advance after confirming image for current segment
            function advanceSegment() {
                if(segIdx < segments.length-1){
                    segIdx += 1;
                    if(segDivs.length>segIdx){
                        setCurrentSegment(segIdx);
                    }else{
                        renderNextSegment();
                    }
                }
            }
            function prevSegment(){
                if(segIdx>0){
                    segIdx -=1;
                    setCurrentSegment(segIdx);
                }
            }
            loadSegments();
            // ------- end segments -------

            // ------- Export Modal Functions -------
            function showExportModal() {
                const modal = document.getElementById('exportModal');
                const statsEl = document.getElementById('exportStats');
                
                // Calculate statistics
                let totalSelections = 0;
                let segmentCount = 0;
                let statsText = '';
                
                for (const [key, files] of Object.entries(selections)) {
                    if (files && files.length > 0) {
                        totalSelections += files.length;
                        if (key === 'ungrouped') {
                            statsText += `其他圖片: ${files.length} 張
`;
                        } else {
                            segmentCount++;
                            const segmentIdx = parseInt(key);
                            const segment = segments[segmentIdx];
                            if (segment) {
                                statsText += `時間段 ${segment.start}~${segment.end}: ${files.length} 張
`;
                            } else {
                                statsText += `段落 ${key}: ${files.length} 張
`;
                            }
                        }
                    }
                }
                
                if (totalSelections === 0) {
                    statsText = '尚未選擇任何圖片';
                    document.getElementById('confirmExportBtn').disabled = true;
                } else {
                    statsText += `
總計: ${totalSelections} 張圖片, ${segmentCount} 個時間段`;
                    document.getElementById('confirmExportBtn').disabled = false;
                }
                
                statsEl.textContent = statsText;
                modal.classList.add('show');
            }
            
            function hideExportModal() {
                const modal = document.getElementById('exportModal');
                modal.classList.remove('show');
            }
            
            async function confirmExport() {
                const confirmBtn = document.getElementById('confirmExportBtn');
                const originalText = confirmBtn.textContent;
                
                try {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = '匯出中...';
                    
                    const response = await fetch('/export', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            selections: selections
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        hideExportModal();
                        showToast(`匯出成功！檔案已儲存: ${result.filename}`);
                        console.log('Export result:', result);
                    } else {
                        throw new Error(result.detail || '匯出失敗');
                    }
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showToast(`匯出失敗: ${error.message}`);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                }
            }
            
            // Close modal when clicking outside
            document.getElementById('exportModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideExportModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('exportModal');
                    if (modal.classList.contains('show')) {
                        hideExportModal();
                    }
                }
            });
            </script>

        </body> 
    </html>
