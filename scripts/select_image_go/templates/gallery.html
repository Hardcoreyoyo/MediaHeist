<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Image Selector</title>

        <style>
            body { font-family: "Source Code Pro", "Courier New", monospace; margin:0; padding:0; background:#000; color:#eee; }
            a{color:#0af;}
            .container { display: flex; margin-top: 72px; height: calc(100vh - 72px); }
            #rightPane { flex: 1; display: flex; flex-direction: column; }
            #navBtns { padding:4px; border-top:1px solid #333; display:flex; gap:8px; justify-content:center; }
            #navBtns button { padding:4px 8px; cursor:pointer; }
            #infoPane { padding: 0.5rem; border-bottom: 1px solid #333; flex: 0 0 30%; max-height: 30%; overflow-y: auto; background:#000; }
            #fileList { width: 16%; border-right: 1px solid #333; overflow-y: auto; padding: 1rem; padding-top: 0px; box-sizing:border-box;padding-left: 24px; }
            #fileList ul { list-style: none; margin: 0; padding: 0; }
            #fileList li { cursor: pointer; padding: 4px 2px; user-select: none; }
            
            .segment-group { margin-bottom: 1rem; }
            .segment-header { 
                font-weight: bold; 
                color: #eee; 
                background-color: #111; 
                padding: 6px 8px; 
                margin: 4px 0; 
                border-left: 3px solid #007acc;
                font-size: 0.9em;
            }
            .segment-header.active { background-color: #222; border-left-color: #0f0; }
            .segment-images { margin-left: 8px; }
            .segment-images li { padding-left: 8px; border-left: 1px solid #e0e0e0; scroll-margin-top: 80px; }
            .selected {
            background-color: transparent;
            position: relative;
            font-weight: bold;
            }
            .selected::before {
                color: #0f0;  /* bright green arrow */
                content: "\2192";
                position: absolute;
                left: -20px;

                font-weight: bold;
            }
            .confirmed {
            background-color: transparent;
            position: relative;
            }
            .confirmed::after {
                color: #0af;  /* bright cyan bullet */
                content: " \2022";

                margin-left: 4px;

                border-left: 3px solid #0f0;}
            #toast { position: fixed; right: 1rem; bottom: 1rem; background: rgba(0,0,0,0.8); color:#fff; padding:8px 12px; border-radius:4px; opacity:0; transition: opacity .3s; pointer-events:none; z-index: 1000; border-left: 3px solid #0f0; }
            #toast.show { opacity: 1; }
            
            /* Right panel segment styles */
            .segment {
                margin-bottom: 1rem;
                padding: 0.5rem;
                border-left: 3px solid #333;
            }
            .segment.current-seg {
                border-left-color: #0f0;
                background-color: #111;
            }
            .seg-title {
                font-weight: bold;
                color: #007acc;
                margin-bottom: 0.5rem;
            }
            .seg-images {
                margin-top: 0.5rem;
            }
            #preview { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 1rem; }
            #preview img { height: auto; width: auto; max-width: 100%; max-height: 100%; }
            .segment { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e0e0e0; padding-left: 8px;}
            .seg-title { font-weight: bold; color: #eee; margin-bottom: 0.25rem; }
            .seg-images { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
            .seg-images img { max-width:100px; height:auto; border:1px solid #ccc; }
            .current-seg { background-color:#222; border-left:3px solid #0f0; }
            
            /* Modal styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            }
            .modal-overlay.show {
                display: flex;
            }
            .modal-content {
                background: #000; color:#eee; border:1px solid #333;
                border-radius: 8px;
                padding: 2rem;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            }
            .modal-header {
                font-size: 1.2em;
                font-weight: bold;
                margin-bottom: 1rem;
                color: #eee;
            }
            .modal-body {
                margin-bottom: 1.5rem;
                line-height: 1.5;
                color: #ccc;
            }
            .modal-stats {
                background: #111; color:#eee; border:1px solid #333;
                padding: 1rem;
                border-radius: 4px;
                margin: 1rem 0;
                font-family: monospace;
                font-size: 0.9em;
                white-space: pre-wrap;
            }
            .modal-buttons {
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
            }
            .modal-btn {
                padding: 0.5rem 1.5rem;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1em;
                transition: background-color 0.2s;
            }
            .modal-btn-cancel {
                background: #222; color:#eee; border:1px solid #333;
            }
            .modal-btn-cancel:hover {
                background: #444;
            }
            .modal-btn-confirm {
                background: #0f0; color:#000; font-weight:bold;
            }
            .modal-btn-confirm:hover {
                background: #0c0;
            }
            .modal-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
        </style>
        </head>

        <body>
            <h2 style="position:sticky; top:0; z-index:1500; background:#000; color:#eee; margin:0; padding:1rem; border-bottom:1px solid #333;">Image Selector <span style="font-size:0.7em; color:#888;">(Cmd+Enter 匯出)</span></h2>
            <div class="container">
            <div id="fileList">
                {{if and .grouped_images .segments}}
                    <!-- Grouped by segments -->
                    {{range $i, $segment := .segments}}
                        {{$segmentKey := printf "segment_%d" $i}}
                        {{$segmentImages := index $.grouped_images $segmentKey}}
                        {{if $segmentImages}}
                        <div class="segment-group">
                            <div class="segment-header" data-segment="{{$i}}">
                                {{if $segment.StartStr}}{{$segment.StartStr}}{{else}}{{$segment.Start}}{{end}} ~ {{if $segment.EndStr}}{{$segment.EndStr}}{{else}}{{$segment.End}}{{end}}
                                <br><span style="font-weight: normal; font-size: 0.85em; color: #666;">
                                {{if gt (len $segment.CleanText) 50}}{{slice $segment.CleanText 0 50}}...{{else}}{{$segment.CleanText}}{{end}}
                                </span>
                            </div>
                            <ul class="segment-images">
                                {{range $segmentImages}}
                                <li data-file="{{.}}" data-segment="{{$i}}">{{.}}</li>
                                {{end}}
                            </ul>
                        </div>
                        {{end}}
                    {{end}}
                    
                    <!-- Ungrouped images -->
                    {{$ungrouped := index .grouped_images "ungrouped"}}
                    {{if $ungrouped}}
                    <div class="segment-group">
                        <div class="segment-header">其他圖片</div>
                        <ul class="segment-images">
                            {{range $ungrouped}}
                            <li data-file="{{.}}" data-segment="ungrouped">{{.}}</li>
                            {{end}}
                        </ul>
                    </div>
                    {{end}}
                {{else}}
                    <!-- Fallback: show all images without grouping -->
                    <ul>
                    {{range .images}}
                    <li data-file="{{.}}" data-segment="ungrouped">{{.}}</li>
                    {{end}}
                    </ul>
                {{end}}
            </div>
                <div id="rightPane">
                    <div id="infoPane"></div>
                    <div id="preview" style="flex:1; display:flex; justify-content:center; align-items:flex-start; padding:1rem;">
                        <img id="previewImg" src="" alt="preview" />
                    </div>
                </div>
            </div>
            <div id="toast" ></div>

            <!-- Export Modal -->
            <div id="exportModal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">準備匯出...</div>
                    <div class="modal-body">
                        確認要匯出以下選擇的圖片嗎？
                    </div>
                    <div id="exportStats" class="modal-stats"></div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-btn-cancel" onclick="hideExportModal()">取消</button>
                        <button id="confirmExportBtn" class="modal-btn modal-btn-confirm" onclick="confirmExport()">確認匯出</button>
                    </div>
                </div>
            </div>

            <script>
            async function postSelection(file) {
                const res = await fetch('/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: file })
                });
                if (!res.ok) {
                    alert('Error: ' + (await res.text()));
                }
            }

            function showPreview(file) {
                const img = document.getElementById('previewImg');
                img.src = '/static/' + file;
            }
            
            </script>
            
            <script>
            // --- enhanced navigation and selection ---
            const listItems = Array.from(document.querySelectorAll('#fileList li[data-file]'));
            const segmentHeaders = Array.from(document.querySelectorAll('.segment-header[data-segment]'));

            // toast helper
            function showToast(msg){
                const toast=document.getElementById('toast');
                toast.textContent=msg;
                toast.classList.add('show');
                setTimeout(()=>toast.classList.remove('show'),2000);
            }

            function confirmFile(file, li){
                const segmentIdx = li ? li.dataset.segment : String(segIdx);
                const actualSegIdx = segmentIdx !== 'ungrouped' ? parseInt(segmentIdx) : segIdx;
                const selectionKey = segmentIdx === 'ungrouped' ? 'ungrouped' : String(actualSegIdx >= 0 ? actualSegIdx : segIdx);
                const selArr = (selections[selectionKey] ??= []);
                const wrap = segDivs[actualSegIdx >= 0 ? actualSegIdx : 0]?.querySelector('.seg-images');
                const idx = selArr.indexOf(file);
                if(idx === -1){
                    // add
                    postSelection(file);
                    selArr.push(file);
                    if(li) li.classList.add('confirmed');
                    showToast('已添加內容');
                    if(wrap && segmentIdx !== 'ungrouped'){
                        const thumb = document.createElement('img');
                        thumb.src = '/static/' + file;
                        thumb.dataset.file = file;
                        wrap.appendChild(thumb);
                        // after adding, align segment bottom to pane bottom
                        const pane = document.getElementById('infoPane');
                        const seg = segDivs[segIdx];
                        if(seg){
                            const bottom = seg.getBoundingClientRect().bottom - pane.getBoundingClientRect().top + pane.scrollTop;
                            const target = bottom - pane.clientHeight;
                            pane.scrollTo({top: target, behavior:'auto'});
                        }
                    }
                }else{
                    // remove
                    selArr.splice(idx,1);
                    if(li) li.classList.remove('confirmed');
                    showToast('已移除');
                    if(wrap && segmentIdx !== 'ungrouped'){
                        const img = wrap.querySelector(`img[data-file="${file}"]`);
                        if(img) img.remove();
                    }
                }
            }

            let currentIndex = 0;
            function highlight(idx) {
                if (listItems.length === 0) return;
                listItems.forEach(li => li.classList.remove('selected'));
                segmentHeaders.forEach(h => h.classList.remove('active'));
                currentIndex = (idx + listItems.length) % listItems.length;
                const li = listItems[currentIndex];
                li.classList.add('selected');
                li.scrollIntoView({behavior:'auto',block:'nearest'});
                showPreview(li.dataset.file);
                
                // Highlight corresponding segment header
                const segmentIdx = li.dataset.segment;
                if (segmentIdx !== 'ungrouped' && segmentIdx !== '-1') {
                    const header = segmentHeaders.find(h => h.dataset.segment === segmentIdx);
                    if (header) header.classList.add('active');
                }
            }

            // Move cursor within current segment only
            function nextInSegment(delta){
                if(listItems.length===0) return;
                const currentSeg = String(segIdx);
                let idx = currentIndex;
                do{
                    idx = (idx + delta + listItems.length) % listItems.length;
                }while(listItems[idx].dataset.segment !== currentSeg && idx !== currentIndex);
                highlight(idx);
            }

            // initial highlight first item
            if (listItems.length) {
                highlight(0);
            }

            // click handler override to use highlight and confirm
            listItems.forEach((li, idx) => {
                li.addEventListener('click', () => {
                    highlight(idx);
                    confirmFile(li.dataset.file, li);
                });
            });

            // keyboard navigation
            const nextBtnEl = document.getElementById('nextBtn');
            if(nextBtnEl) nextBtnEl.addEventListener('click', advanceSegment);
            const prevBtnEl = document.getElementById('prevBtn');
            if(prevBtnEl) prevBtnEl.addEventListener('click', prevSegment);

            window.addEventListener('keydown', (ev) => {
                // Ignore global shortcuts while export modal is open
                const exportModal = document.getElementById('exportModal');
                if (exportModal && exportModal.classList.contains('show')) {
                    return; // let modal handler manage keys
                }
                // Check for Cmd+Enter (Mac) or Ctrl+Enter (Windows/Linux)
                if ((ev.metaKey || ev.ctrlKey) && ev.key === 'Enter') {
                    ev.preventDefault();
                    showExportModal();
                    return;
                }
                
                // Arrow key navigation
                if (ev.key === 'ArrowDown') {
                    ev.preventDefault();
                    nextInSegment(1);
                } else if (ev.key === 'ArrowUp') {
                    ev.preventDefault();
                    nextInSegment(-1);
                } else if (ev.key === 'ArrowRight') {
                    ev.preventDefault();
                    advanceSegment();
                } else if (ev.key === 'ArrowLeft') {
                    ev.preventDefault();
                    prevSegment();
                } else if (ev.key === 'Enter' || ev.code === 'Space') {
                    ev.preventDefault();
                    if (listItems[currentIndex]) {
                        confirmFile(listItems[currentIndex].dataset.file, listItems[currentIndex]);
                    }
                }
            });
            // --- end navigation ---

            // ------- segment navigation with dynamic loading -------
            let segments = [];
            let segIdx = 0;
            let segDivs = [];
            const selections = {}; // segIdx -> array of filenames
            
            async function loadSegments() {
                const res = await fetch('/segments');
                if (!res.ok) return;
                segments = await res.json();
                renderNextSegment();
            }
            
            function renderNextSegment() {
                if (segIdx >= segments.length) return;
                const pane = document.getElementById('infoPane');
                const seg = segments[segIdx];
                const div = document.createElement('div');
                div.className = 'segment';
                const title = document.createElement('div');
                title.className = 'seg-title';
                title.textContent = `${seg.start_str || seg.start} ~ ${seg.end_str || seg.end}`;
                const p = document.createElement('p');
                p.textContent = seg.clean_text || seg.text;
                const imgWrap = document.createElement('div');
                imgWrap.className = 'seg-images';
                div.appendChild(title);
                div.appendChild(p);
                div.appendChild(imgWrap);
                pane.appendChild(div);
                segDivs.push(div);
                pane.scrollTop = pane.scrollHeight;
                setCurrentSegment(segIdx);
            }
            
            function setCurrentSegment(idx){
                // 更新左側段落高亮
                const segmentHeaders = document.querySelectorAll('.segment-header');
                segmentHeaders.forEach(h => h.classList.remove('active'));
                
                if(idx >= 0 && idx < segmentHeaders.length){
                    segmentHeaders[idx].classList.add('active');
                }
                
                // 更新右側面板高亮
                segDivs.forEach(d => d.classList.remove('current-seg'));
                if (idx >= 0 && idx < segDivs.length) {
                    segDivs[idx].classList.add('current-seg');
                    const pane = document.getElementById('infoPane');
                    const target = segDivs[idx].getBoundingClientRect().top - pane.getBoundingClientRect().top + pane.scrollTop;
                    pane.scrollTo({top: target, behavior: 'smooth'});
                }

                // 自動高亮屬於此段落的第一張圖片
                const firstLi = listItems.find(li => li.dataset.segment === String(idx));
                if(firstLi){
                    highlight(listItems.indexOf(firstLi));
                    firstLi.scrollIntoView({behavior:'smooth', block:'start'});
                }
                
                // 刷新文件列表的確認狀態
                listItems.forEach(li=>li.classList.remove('confirmed'));
                const selectedFiles = selections[String(idx)] ?? [];
                const ungroupedFiles = selections['ungrouped'] ?? [];
                listItems.forEach(li=>{
                    const segmentIdx = li.dataset.segment;
                    if(segmentIdx === 'ungrouped' && ungroupedFiles.includes(li.dataset.file)){
                        li.classList.add('confirmed');
                    } else if(segmentIdx === String(idx) && selectedFiles.includes(li.dataset.file)){
                        li.classList.add('confirmed');
                    }
                });
            }
            
            // 前進到下一個段落
            function advanceSegment() {
                if (segIdx < segments.length - 1) {
                    segIdx += 1;
                    if (segDivs.length > segIdx) {
                        setCurrentSegment(segIdx);
                    } else {
                        renderNextSegment();
                    }
                }
            }
            
            function prevSegment() {
                if (segIdx > 0) {
                    segIdx -= 1;
                    setCurrentSegment(segIdx);
                }
            }
            
            // Initialize
            loadSegments();
            if (listItems.length > 0) {
                listItems[currentIndex].classList.add('selected');
                showPreview(listItems[currentIndex].dataset.file);
            }
            // ------- end segments -------

            // ------- Export Modal Functions -------
            function modalKeyHandler(e) {
                const modal = document.getElementById('exportModal');
                if (!modal.classList.contains('show')) return;
                e.stopPropagation();
                if (e.key === 'Enter' || e.code === 'Space') {
                    e.preventDefault();
                    confirmExport();
                } else if (e.key === 'n' || e.key === 'N' || e.key === 'Escape') {
                    e.preventDefault();
                    hideExportModal();
                }
            }
            
            function showExportModal() {
                const modal = document.getElementById('exportModal');
                const statsEl = document.getElementById('exportStats');
                
                let totalSelections = 0;
                let segmentCount = 0;
                let statsText = '';
                
                for (const [key, files] of Object.entries(selections)) {
                    if (files && files.length > 0) {
                        totalSelections += files.length;
                        segmentCount++;
                        
                        if (key === 'ungrouped') {
                            statsText += `

其他圖片: ${files.length} 張


`;
                        } else {
                            const segmentIndex = parseInt(key);
                            const segment = segments[segmentIndex];
                            if (segment) {
                                statsText += `

時間段 ${segment.start}~${segment.end}: ${files.length} 張


`;
                            } else {
                                statsText += `

段落 ${key}: ${files.length} 張


`;
                            }
                        }
                    }
                }
                
                if (totalSelections === 0) {
                    statsText = '尚未選擇任何圖片';
                    document.getElementById('confirmExportBtn').disabled = true;
                } else {
                    statsText += `
總計: ${totalSelections} 張圖片, ${segmentCount} 個時間段`;
                    document.getElementById('confirmExportBtn').disabled = false;
                }
                
                statsEl.textContent = statsText;
                // Ensure element can receive keyboard focus for arrow scrolling
                statsEl.setAttribute('tabindex', '-1');
                statsEl.focus();
                // Prevent background page from scrolling while modal open
                document.body.style.overflow = 'hidden';
                modal.classList.add('show');
                // Attach modal-specific key handler with high priority (capture phase)
                document.addEventListener('keydown', modalKeyHandler, true);
            }
            
            function hideExportModal() {
                const modal = document.getElementById('exportModal');
                modal.classList.remove('show');
                // Restore page scroll
                document.body.style.overflow = '';
                // Detach modal-specific key handler
                document.removeEventListener('keydown', modalKeyHandler, true);
            }
            
            async function confirmExport() {
                const confirmBtn = document.getElementById('confirmExportBtn');
                const originalText = confirmBtn.textContent;
                
                try {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = '匯出中...';
                    
                    const response = await fetch('/export', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            selections: selections
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        hideExportModal();
                        showToast(`匯出成功！檔案已儲存: ${result.filename}`);
                        console.log('Export result:', result);
                    } else {
                        throw new Error(result.detail || '匯出失敗');
                    }
                    
                } catch (error) {
                    console.error('Export error:', error);
                    showToast(`匯出失敗: ${error.message}`);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = originalText;
                }
            }
            
            // Close modal when clicking outside
            document.getElementById('exportModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideExportModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('exportModal');
                    if (modal.classList.contains('show')) {
                        hideExportModal();
                    }
                }
            });
            </script>

        </body> 
    </html>
