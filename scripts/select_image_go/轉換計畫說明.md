# Python FastAPI 到 Golang Gin 轉換計畫說明

## 原版程式分析

### 核心功能
1. **圖片瀏覽與選擇**: 從指定目錄掃描圖片檔案，提供 Web 介面預覽和選擇
2. **轉錄文件整合**: 解析時間戳記轉錄文件，將圖片按時間戳分組到對應段落
3. **Markdown 匯出**: 將選擇的圖片整合到轉錄文件中，匯出為 Markdown 格式
4. **即時更新**: 背景任務定期掃描目錄更新圖片列表

### 技術架構
- **後端**: FastAPI + Uvicorn ASGI 伺服器
- **前端**: 純 HTML/CSS/JavaScript，使用 Jinja2 模板
- **檔案服務**: FastAPI StaticFiles 中介軟體
- **資料格式**: JSON API，支援 RESTful 端點

### API 端點分析
1. `GET /` - 主頁面，返回 HTML 模板
2. `POST /select` - 選擇/取消選擇圖片
3. `GET /segments` - 獲取轉錄段落資料
4. `POST /export` - 匯出選擇的圖片和 Markdown
5. `GET /static/*` - 靜態圖片檔案服務

### 關鍵功能模組
1. **圖片掃描**: `scan_images()` - 遞迴掃描支援的圖片格式
2. **時間戳解析**: `parse_frame_timestamp()`, `parse_transcript_timestamp()`
3. **轉錄解析**: `parse_transcript()` - 解析包含時間戳的轉錄文件
4. **圖片分組**: `group_images_by_segments()` - 按時間戳將圖片分配到段落
5. **Markdown 生成**: `generate_markdown()` - 整合圖片到轉錄內容

## Golang Gin 轉換計畫

### 專案結構設計
```
scripts/select_image_go/
├── main.go                 # 主程式入口
├── config.go               # 配置結構和解析
├── models.go               # 資料結構定義
├── handlers.go             # HTTP 處理器
├── image_service.go        # 圖片掃描和管理服務
├── transcript_service.go   # 轉錄解析服務
├── export_service.go       # 匯出服務
├── utils.go                # 工具函數
├── templates/
│   └── gallery.html        # HTML 模板
├── static/                 # 靜態資源目錄（運行時動態）
├── go.mod                  # Go 模組定義
├── go.sum                  # 依賴校驗
├── README.md               # 使用說明
└── build.sh                # 編譯腳本
```

### 核心依賴選擇
- **Go 版本**: Go 1.24+ (必須)
- **Web 框架**: `github.com/gin-gonic/gin` - 高效能 HTTP 框架
- **模板引擎**: Go 內建 `html/template` - 相容 Jinja2 語法
- **檔案監控**: `github.com/fsnotify/fsnotify` - 檔案變更監控
- **配置解析**: Go 內建 `flag` 套件
- **JSON 處理**: Go 內建 `encoding/json`
- **正規表達式**: Go 內建 `regexp`

### 功能對應轉換

#### 1. 配置管理 (config.go)
```go
type Config struct {
    BaseDir       string `json:"base_dir"`
    RefreshSecs   int    `json:"refresh_secs"`
    Port          int    `json:"port"`
    TranscriptPath string `json:"transcript_path,omitempty"`
    OutputDir     string `json:"output_dir"`
}
```

#### 2. 資料模型 (models.go)
```go
type SelectionPayload struct {
    Filename string `json:"filename"`
}

type ExportPayload struct {
    Selections map[string][]string `json:"selections"`
}

type Segment struct {
    Start float64 `json:"start"`
    End   float64 `json:"end"`
    Text  string  `json:"text"`
}
```

#### 3. HTTP 處理器 (handlers.go)
- `IndexHandler()` - 對應 `create_app.index`
- `SelectHandler()` - 對應 `create_app.select`
- `SegmentsHandler()` - 對應 `create_app.segments`
- `ExportHandler()` - 對應 `create_app.export_markdown`

#### 4. 圖片服務 (image_service.go)
- `ScanImages()` - 對應 `scan_images()`
- `ParseFrameTimestamp()` - 對應 `parse_frame_timestamp()`
- `GroupImagesBySegments()` - 對應 `group_images_by_segments()`
- 背景更新任務使用 Goroutine + Timer

#### 5. 轉錄服務 (transcript_service.go)
- `ParseTranscript()` - 對應 `parse_transcript()`
- `ParseTranscriptTimestamp()` - 對應 `parse_transcript_timestamp()`

#### 6. 匯出服務 (export_service.go)
- `GenerateMarkdown()` - 對應 `generate_markdown()`
- `ExportSelectedImages()` - 檔案複製和目錄管理

### 關鍵技術實現

#### 1. 靜態檔案服務
```go
// 使用 Gin 的靜態檔案中介軟體
router.Static("/static", config.BaseDir)
```

#### 2. 模板渲染
```go
// 使用 Go 內建模板引擎
router.LoadHTMLGlob("templates/*")
router.GET("/", handlers.IndexHandler)
```

#### 3. 背景任務
```go
// 使用 Goroutine 實現背景掃描
go func() {
    ticker := time.NewTicker(time.Duration(config.RefreshSecs) * time.Second)
    for range ticker.C {
        imageService.RefreshImages()
    }
}()
```

#### 4. 錯誤處理
```go
// 統一錯誤處理中介軟體
func ErrorHandler() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()
        if len(c.Errors) > 0 {
            c.JSON(500, gin.H{"error": c.Errors.Last().Error()})
        }
    }
}
```

### UI/UX 保持一致性

#### 1. HTML 模板轉換
- 將 Jinja2 語法轉換為 Go template 語法
- 保持所有 CSS 樣式不變
- 保持 JavaScript 邏輯完全一致

#### 2. API 回應格式
- 保持 JSON 結構完全相同
- HTTP 狀態碼對應一致
- 錯誤訊息格式統一

#### 3. 功能行為
- 鍵盤導航（左右方向鍵）
- 圖片選擇視覺回饋
- Toast 通知系統
- 匯出確認對話框

### 效能優化

#### 1. 記憶體管理
- 使用 sync.RWMutex 保護共享資料
- 圖片列表快取機制
- 避免不必要的檔案系統操作

#### 2. 並發處理
- Goroutine 處理背景任務
- Channel 用於任務通訊
- Context 用於請求取消

#### 3. 檔案 I/O 優化
- 批次檔案操作
- 檔案路徑快取
- 避免重複掃描

### 安全性考量

#### 1. 路徑驗證
```go
// 防止路徑遍歷攻擊
func validatePath(basePath, requestPath string) error {
    cleanPath := filepath.Clean(requestPath)
    if strings.Contains(cleanPath, "..") {
        return errors.New("invalid path")
    }
    return nil
}
```

#### 2. 檔案類型驗證
```go
// 只允許特定圖片格式
var allowedExts = map[string]bool{
    ".jpg": true, ".jpeg": true, ".png": true, ".gif": true,
}
```

#### 3. 輸入驗證
- JSON 資料結構驗證
- 檔案名稱格式檢查
- 路徑安全性檢查

### 編譯與部署

#### 0. 系統要求
- **Go 版本**: Go 1.24 或更高版本
- **作業系統**: Linux/Windows/macOS

#### 1. 跨平台編譯
```bash
# 確認 Go 版本
go version  # 應該顯示 1.24 或更高

# Linux
GOOS=linux GOARCH=amd64 go build -o select_image_linux

# Windows
GOOS=windows GOARCH=amd64 go build -o select_image.exe

# macOS
GOOS=darwin GOARCH=amd64 go build -o select_image_macos
```

#### 2. 單一二進制檔案
- 使用 `embed` 套件內嵌模板檔案
- 靜態連結，無外部依賴
- 檔案大小優化

### 使用方式

#### 1. 命令列參數
```bash
./select_image_go \
  --base-dir /path/to/images \
  --transcript /path/to/transcript.txt \
  --output-dir /path/to/output \
  --port 8000 \
  --refresh-secs 15
```

#### 2. 預設值
- Port: 15687 (與原版一致)
- Refresh interval: 15 秒
- Output directory: ./output

### 測試策略

#### 1. 單元測試
- 各服務模組獨立測試
- 工具函數測試
- 錯誤處理測試

#### 2. 整合測試
- API 端點測試
- 檔案操作測試
- 模板渲染測試

#### 3. 效能測試
- 大量圖片處理
- 並發請求處理
- 記憶體使用監控

## 實施步驟

1. **專案初始化** - 建立 Go 模組和基本結構
2. **核心服務實現** - 圖片掃描、轉錄解析、匯出功能
3. **HTTP 處理器** - API 端點實現
4. **模板轉換** - HTML 模板適配
5. **靜態檔案服務** - 圖片檔案服務
6. **背景任務** - 定期掃描機制
7. **錯誤處理** - 統一錯誤處理機制
8. **測試驗證** - 功能測試和效能驗證
9. **編譯打包** - 跨平台編譯腳本
10. **文件撰寫** - README 和使用說明

## 預期成果

### 功能完整性
- ✅ 100% 功能對等轉換
- ✅ UI/UX 完全一致
- ✅ API 回應格式相同
- ✅ 鍵盤操作支援

### 效能提升
- 🚀 啟動速度更快（無需 Python 環境）
- 🚀 記憶體使用更低
- 🚀 並發處理能力更強
- 🚀 檔案 I/O 效能更佳

### 部署優勢
- 📦 單一二進制檔案
- 🔧 無外部依賴
- 🌐 跨平台支援
- 💾 檔案體積更小

這個轉換計畫確保了功能完整性、效能優化和部署便利性，同時保持與原版 Python 程式完全一致的使用體驗。
